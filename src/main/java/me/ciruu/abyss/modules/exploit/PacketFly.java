package me.ciruu.abyss.modules.exploit;

import com.mojang.realmsclient.gui.ChatFormatting;
import io.netty.util.internal.ConcurrentSet;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.TimeUnit;
import java.util.function.Predicate;
import me.ciruu.abyss.Class25;
import me.ciruu.abyss.Class26;
import me.ciruu.abyss.Class443;
import me.ciruu.abyss.Class56;
import me.ciruu.abyss.Globals;
import me.ciruu.abyss.Manager;
import me.ciruu.abyss.enums.Class11;
import me.ciruu.abyss.enums.Class226;
import me.ciruu.abyss.enums.Class324;
import me.ciruu.abyss.enums.Class53;
import me.ciruu.abyss.enums.Class614;
import me.ciruu.abyss.events.network.EventNetworkPostPacketEvent;
import me.ciruu.abyss.events.network.EventNetworkPrePacketEvent;
import me.ciruu.abyss.events.player.EventPlayerMove;
import me.ciruu.abyss.events.player.EventPlayerUpdateWalking;
import me.ciruu.abyss.modules.Module;
import me.ciruu.abyss.settings.Setting;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.entity.Entity;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketConfirmTeleport;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.server.SPacketPlayerPosLook;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Vec3d;

public class PacketFly
extends Module {
    private final Setting main = new Setting("Main", "", this, new Class25("Main Settings"));
    private final Setting mode = new Setting("Mode", "", this, (Object)Class614.Fast);
    private final Setting speed = new Setting("Speed", "", (Module)this, (Object)Float.valueOf(1.0f), Float.valueOf(0.0f), Float.valueOf(1.0f));
    private final Setting factor = new Setting("Factor", "", this, 1, 1, 10, this.main, this::Method4275);
    private final Setting increaseTicks = new Setting("IncreaseTicks", "", this, 20, 1, 20, this.main, this::Method4276);
    private final Setting phase = new Setting("Phase", "", this, (Object)Class324.Full);
    private final Setting type = new Setting("Type", "", this, (Object)Class226.Preserve);
    private final Setting timer = new Setting("Timer", "", (Module)this, (Object)Float.valueOf(1.0f), Float.valueOf(0.1f), Float.valueOf(2.0f));
    private final Setting antiKick = new Setting("AntiKick", "", this, true);
    private final Setting limit = new Setting("Limit", "", (Module)this, (Object)false, this.main, this::Method4277);
    private final Setting autoClip = new Setting("AutoClip", "", this, false);
    private int Field3526 = -1;
    private ConcurrentSet Field3527 = new ConcurrentSet();
    private Random Field3528 = new Random();
    private ConcurrentHashMap Field3529 = new ConcurrentHashMap();
    private int Field3530 = 0;
    private int Field3531 = 0;
    private int Field3532 = 0;
    private boolean Field3533 = false;
    private boolean Field3534 = false;
    @EventHandler
    private Listener Field3535 = new Listener<EventPlayerUpdateWalking>(this::Method4278, new Predicate[0]);
    @EventHandler
    public Listener Field3536 = new Listener<EventPlayerMove>(this::Method4279, new Predicate[0]);
    @EventHandler
    private final Listener Field3537 = new Listener<Class26>(this::Method4280, new Predicate[0]);
    @EventHandler
    public Listener Field3538 = new Listener<EventNetworkPostPacketEvent>(this::Method4281, new Predicate[0]);
    @EventHandler
    private Listener Field3539 = new Listener<EventNetworkPrePacketEvent>(this::Method4282, new Predicate[0]);

    public PacketFly() {
        super("PacketFly", "Allows you to fly with packets.", Class11.EXPLOIT);
        this.Method4283(this.mode);
        this.Method4283(this.speed);
        this.Method4283(this.factor);
        this.Method4283(this.increaseTicks);
        this.Method4283(this.phase);
        this.Method4283(this.type);
        this.Method4283(this.timer);
        this.Method4283(this.antiKick);
        this.Method4283(this.limit);
    }

    public void Method4284() {
        super.Method13();
        this.Field3526 = -1;
        this.Field3531 = 0;
        this.Field3532 = 0;
        if (this.Method4285() && Globals.mc.player != null) {
            this.Method4286();
        }
        if (((Boolean)this.autoClip.getValue()).booleanValue() && this.Field3534) {
            Globals.mc.player.connection.sendPacket((Packet)new CPacketEntityAction((Entity)Globals.mc.player, CPacketEntityAction.Action.STOP_SNEAKING));
        }
    }

    public void Method4287() {
        super.Method15();
        Manager.Field298.Method337(1.0f);
    }

    public String Method4288() {
        return ChatFormatting.WHITE + ((Class614)((Object)this.mode.getValue())).name();
    }

    public void Method4286() {
        this.Field3530 = 0;
        this.Field3526 = 0;
        this.Field3527.clear();
        this.Field3529.clear();
    }

    public boolean Method4289(int n) {
        ++this.Field3530;
        if (this.Field3530 >= n) {
            this.Field3530 = 0;
            return true;
        }
        return false;
    }

    public void Method4290(CPacketPlayer cPacketPlayer) {
        this.Field3527.add((Object)cPacketPlayer);
        Globals.mc.player.connection.sendPacket((Packet)cPacketPlayer);
    }

    private int Method4291() {
        if (Globals.mc.isSingleplayer()) {
            return 2000;
        }
        int n = this.Field3528.nextInt(29000000);
        if (this.Field3528.nextBoolean()) {
            return n;
        }
        return -n;
    }

    public Vec3d Method4292(Vec3d vec3d, Vec3d vec3d2) {
        Vec3d vec3d3 = vec3d.add(vec3d2);
        switch ((Class226)((Object)this.type.getValue())) {
            case Preserve: {
                vec3d3 = vec3d3.add((double)this.Method4291(), 0.0, (double)this.Method4291());
                break;
            }
            case Up: {
                vec3d3 = vec3d3.add(0.0, 1337.0, 0.0);
                break;
            }
            case Down: {
                vec3d3 = vec3d3.add(0.0, -1337.0, 0.0);
                break;
            }
            case Bounds: {
                vec3d3 = new Vec3d(vec3d3.x, Globals.mc.player.posY <= 10.0 ? 255.0 : 1.0, vec3d3.z);
            }
        }
        return vec3d3;
    }

    public void Method4293(Double d, Double d2, Double d3, Boolean bl) {
        Vec3d vec3d = new Vec3d(d.doubleValue(), d2.doubleValue(), d3.doubleValue());
        Vec3d vec3d2 = Globals.mc.player.getPositionVector().add(vec3d);
        Vec3d vec3d3 = this.Method4292(vec3d, vec3d2);
        this.Method4290((CPacketPlayer)new CPacketPlayer.Position(vec3d2.x, vec3d2.y, vec3d2.z, Globals.mc.player.onGround));
        this.Method4290((CPacketPlayer)new CPacketPlayer.Position(vec3d3.x, vec3d3.y, vec3d3.z, Globals.mc.player.onGround));
        if (bl.booleanValue()) {
            Globals.mc.player.connection.sendPacket((Packet)new CPacketConfirmTeleport(++this.Field3526));
            this.Field3529.put(this.Field3526, new Class443(vec3d2.x, vec3d2.y, vec3d2.z, System.currentTimeMillis()));
        }
    }

    private boolean Method4294() {
        return !Globals.mc.world.getCollisionBoxes((Entity)Globals.mc.player, Globals.mc.player.getEntityBoundingBox().expand(-0.0625, -0.0625, -0.0625)).isEmpty();
    }

    private void Method4282(EventNetworkPrePacketEvent eventNetworkPrePacketEvent) {
        if (Globals.mc.player != null && eventNetworkPrePacketEvent.Method49() instanceof SPacketPlayerPosLook) {
            SPacketPlayerPosLook sPacketPlayerPosLook = (SPacketPlayerPosLook)eventNetworkPrePacketEvent.Method49();
            Class443 class443 = (Class443)this.Field3529.remove(sPacketPlayerPosLook.teleportId);
            if (Globals.mc.player.isEntityAlive() && Globals.mc.world.isBlockLoaded(new BlockPos(Globals.mc.player.posX, Globals.mc.player.posY, Globals.mc.player.posZ), false) && !(Globals.mc.currentScreen instanceof GuiDownloadTerrain) && this.mode.getValue() != Class614.Rubber && class443 != null && Class443.Method1920(class443) == sPacketPlayerPosLook.x && Class443.Method1921(class443) == sPacketPlayerPosLook.y && Class443.Method1922(class443) == sPacketPlayerPosLook.z) {
                eventNetworkPrePacketEvent.cancel();
                return;
            }
            sPacketPlayerPosLook.yaw = Globals.mc.player.rotationYaw;
            sPacketPlayerPosLook.pitch = Globals.mc.player.rotationPitch;
            this.Field3526 = sPacketPlayerPosLook.getTeleportId();
        }
    }

    private void Method4281(EventNetworkPostPacketEvent eventNetworkPostPacketEvent) {
        if (eventNetworkPostPacketEvent.Method16() instanceof CPacketPlayer) {
            if (this.Field3527.contains((Object)((CPacketPlayer)eventNetworkPostPacketEvent.Method16()))) {
                this.Field3527.remove((Object)((CPacketPlayer)eventNetworkPostPacketEvent.Method16()));
                return;
            }
            eventNetworkPostPacketEvent.cancel();
        }
    }

    private void Method4280(Class26 class26) {
        this.Field3529.entrySet().removeIf(PacketFly::Method4295);
    }

    private static boolean Method4295(Map.Entry entry) {
        return System.currentTimeMillis() - ((Class443)entry.getValue()).Method1915() > TimeUnit.SECONDS.toMillis(30L);
    }

    private void Method4279(EventPlayerMove eventPlayerMove) {
        if (!eventPlayerMove.isCancelled()) {
            if (this.mode.getValue() != Class614.Rubber && this.Field3526 == 0) {
                return;
            }
            eventPlayerMove.cancel();
            eventPlayerMove.Method107(Globals.mc.player.motionX);
            eventPlayerMove.Method105(Globals.mc.player.motionY);
            eventPlayerMove.Method108(Globals.mc.player.motionZ);
            if (this.phase.getValue() != Class324.Off && (this.phase.getValue() == Class324.Semi || this.Method4294())) {
                Globals.mc.player.noClip = true;
            }
        }
    }

    private void Method4278(EventPlayerUpdateWalking eventPlayerUpdateWalking) {
        if (eventPlayerUpdateWalking.Method100() != Class53.PRE) {
            return;
        }
        if ((double)((Float)this.timer.getValue()).floatValue() != 1.0) {
            Manager.Field298.Method337(((Float)this.timer.getValue()).floatValue());
        }
        Globals.mc.player.setVelocity(0.0, 0.0, 0.0);
        if (this.mode.getValue() != Class614.Rubber && this.Field3526 == 0) {
            if (this.Method4289(4)) {
                this.Method4293(0.0, 0.0, 0.0, false);
            }
            return;
        }
        boolean bl = this.Method4294();
        double d = 0.0;
        d = Globals.mc.player.movementInput.jump && (bl || !Class56.Method103()) ? (((Boolean)this.antiKick.getValue()).booleanValue() && !bl ? (this.Method4289(this.mode.getValue() == Class614.Rubber ? 10 : 20) ? -0.032 : 0.062) : 0.062) : (Globals.mc.player.movementInput.sneak ? -0.062 : (!bl ? (this.Method4289(4) ? (((Boolean)this.antiKick.getValue()).booleanValue() ? -0.04 : 0.0) : 0.0) : 0.0));
        if (this.phase.getValue() == Class324.Full && bl && Class56.Method103() && d != 0.0) {
            d = Globals.mc.player.movementInput.jump ? (d /= 2.5) : (d /= 1.5);
        }
        if (Globals.mc.player.movementInput.jump && ((Boolean)this.autoClip.getValue()).booleanValue()) {
            Globals.mc.player.connection.sendPacket((Packet)new CPacketEntityAction((Entity)Globals.mc.player, this.Field3534 ? CPacketEntityAction.Action.START_SNEAKING : CPacketEntityAction.Action.STOP_SNEAKING));
            this.Field3534 = !this.Field3534;
        }
        double[] dArray = Class56.Method3180(this.phase.getValue() == Class324.Full && bl ? 0.034444444444444444 : (double)((Float)this.speed.getValue()).floatValue() * 0.26);
        int n = 1;
        if (this.mode.getValue() == Class614.Factor && Globals.mc.player.ticksExisted % (Integer)this.increaseTicks.getValue() == 0) {
            n = (Integer)this.factor.getValue();
        }
        for (int i = 1; i <= n; ++i) {
            if (this.mode.getValue() == Class614.Limit) {
                if (Globals.mc.player.ticksExisted % 2 == 0) {
                    if (this.Field3533 && d >= 0.0) {
                        this.Field3533 = false;
                        d = -0.032;
                    }
                    Globals.mc.player.motionX = dArray[0] * (double)i;
                    Globals.mc.player.motionZ = dArray[1] * (double)i;
                    Globals.mc.player.motionY = d * (double)i;
                    this.Method4293(Globals.mc.player.motionX, Globals.mc.player.motionY, Globals.mc.player.motionZ, (Boolean)this.limit.getValue() == false);
                    continue;
                }
                if (!(d < 0.0)) continue;
                this.Field3533 = true;
                continue;
            }
            Globals.mc.player.motionX = dArray[0] * (double)i;
            Globals.mc.player.motionZ = dArray[1] * (double)i;
            Globals.mc.player.motionY = d * (double)i;
            this.Method4293(Globals.mc.player.motionX, Globals.mc.player.motionY, Globals.mc.player.motionZ, this.mode.getValue() != Class614.Rubber);
        }
    }

    private boolean Method4277() {
        return this.mode.getValue() == Class614.Limit;
    }

    private boolean Method4276() {
        return this.mode.getValue() == Class614.Factor && (Integer)this.factor.getValue() > 1;
    }

    private boolean Method4275() {
        return this.mode.getValue() == Class614.Factor;
    }
}

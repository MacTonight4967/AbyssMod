package me.ciruu.abyss.modules.exploit;

import com.mojang.realmsclient.gui.ChatFormatting;
import java.util.function.Predicate;
import me.ciruu.abyss.Class202;
import me.ciruu.abyss.Class22;
import me.ciruu.abyss.Globals;
import me.ciruu.abyss.enums.Class11;
import me.ciruu.abyss.enums.Class53;
import me.ciruu.abyss.enums.Class610;
import me.ciruu.abyss.events.network.EventNetworkPostPacketEvent;
import me.ciruu.abyss.events.player.EventPlayerMove;
import me.ciruu.abyss.events.player.EventPlayerUpdateWalking;
import me.ciruu.abyss.modules.Module;
import me.ciruu.abyss.settings.Setting;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.block.BlockLiquid;
import net.minecraft.entity.Entity;
import net.minecraft.init.Items;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.client.CPacketPlayerTryUseItem;
import net.minecraft.network.play.client.CPacketPlayerTryUseItemOnBlock;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.BlockPos;

public class NoFall
extends Module {
    private final Setting mode = new Setting("Mode", "", this, (Object)Class610.Packet);
    private final Class22 Field2569 = new Class22();
    @EventHandler
    private Listener Field2570 = new Listener<EventNetworkPostPacketEvent>(this::Method3074, new Predicate[0]);
    @EventHandler
    private Listener Field2571 = new Listener<EventPlayerUpdateWalking>(this::Method3075, new Predicate[0]);
    @EventHandler
    private Listener Field2572 = new Listener<EventPlayerMove>(this::Method3076, -4000, new Predicate[0]);

    public NoFall() {
        super("NoFall", "Avoid damage from falls.", Class11.EXPLOIT);
        this.Method3077(this.mode);
    }

    public String Method3078() {
        return ChatFormatting.WHITE + ((Class610)((Object)this.mode.getValue())).name();
    }

    private boolean Method3079(double d, double d2, double d3) {
        return Globals.mc.world.getCollisionBoxes((Entity)Globals.mc.player, Globals.mc.player.getEntityBoundingBox().offset(d, d2, d3)).isEmpty();
    }

    private void Method3076(EventPlayerMove eventPlayerMove) {
        if (this.mode.getValue() != Class610.Avoid) {
            return;
        }
        double d = eventPlayerMove.Method984();
        double d2 = eventPlayerMove.Method985();
        double d3 = eventPlayerMove.Method986();
        if (Globals.mc.player.onGround && !Globals.mc.player.noClip) {
            double d4 = 0.05;
            while (d != 0.0 && this.Method3079(d, -1.0, 0.0)) {
                if (d < d4 && d >= -d4) {
                    d = 0.0;
                    continue;
                }
                if (d > 0.0) {
                    d -= d4;
                    continue;
                }
                d += d4;
            }
            while (d3 != 0.0 && this.Method3079(0.0, -1.0, d3)) {
                if (d3 < d4 && d3 >= -d4) {
                    d3 = 0.0;
                    continue;
                }
                if (d3 > 0.0) {
                    d3 -= d4;
                    continue;
                }
                d3 += d4;
            }
            while (d != 0.0 && d3 != 0.0 && this.Method3079(d, -1.0, d3)) {
                d = d < d4 && d >= -d4 ? 0.0 : (d > 0.0 ? (d -= d4) : (d += d4));
                if (d3 < d4 && d3 >= -d4) {
                    d3 = 0.0;
                    continue;
                }
                if (d3 > 0.0) {
                    d3 -= d4;
                    continue;
                }
                d3 += d4;
            }
        }
        eventPlayerMove.Method107(d);
        eventPlayerMove.Method105(d2);
        eventPlayerMove.Method108(d3);
        eventPlayerMove.cancel();
    }

    private void Method3075(EventPlayerUpdateWalking eventPlayerUpdateWalking) {
        if (eventPlayerUpdateWalking.Method100() != Class53.PRE || this.mode.getValue() == Class610.Avoid) {
            return;
        }
        if (Globals.mc.player.isElytraFlying() || !this.Field2569.Method50(1000L)) {
            return;
        }
        switch ((Class610)((Object)this.mode.getValue())) {
            case Packet: {
                if (!(Globals.mc.player.fallDistance > 3.0f)) break;
                eventPlayerUpdateWalking.cancel();
                eventPlayerUpdateWalking.setOnGround(true);
                break;
            }
            case Bucket: {
                int n;
                if (!(Globals.mc.player.fallDistance > 3.0f)) break;
                BlockPos blockPos = null;
                for (n = (int)Globals.mc.player.posY; n > (int)Globals.mc.player.posY - 5; --n) {
                    BlockPos blockPos2 = new BlockPos(Globals.mc.player.posX, (double)n, Globals.mc.player.posZ);
                    if (Globals.mc.world.isAirBlock(blockPos2) || Globals.mc.world.getBlockState(blockPos2).getBlock() instanceof BlockLiquid) continue;
                    blockPos = blockPos2;
                    break;
                }
                if (blockPos == null) break;
                n = 0;
                if (Globals.mc.player.getHeldItemMainhand().getItem() != Items.WATER_BUCKET) {
                    int n2 = Class202.Method930(Items.WATER_BUCKET);
                    if (n2 != -1) {
                        n = 1;
                        Globals.mc.player.inventory.currentItem = n2;
                        Globals.mc.playerController.updateController();
                    }
                } else {
                    n = 1;
                }
                if (n == 0) break;
                eventPlayerUpdateWalking.cancel();
                eventPlayerUpdateWalking.setPitch(90.0f);
                Globals.mc.player.connection.sendPacket((Packet)new CPacketPlayerTryUseItemOnBlock(blockPos, EnumFacing.UP, EnumHand.MAIN_HAND, 0.0f, 0.0f, 0.0f));
                Globals.mc.player.connection.sendPacket((Packet)new CPacketPlayerTryUseItem(EnumHand.MAIN_HAND));
                break;
            }
            case AAC: {
                if (Globals.mc.player.fallDistance > 3.0f) {
                    Globals.mc.player.fallDistance = 0.0f;
                    Globals.mc.player.onGround = true;
                    Globals.mc.player.capabilities.isFlying = true;
                    Globals.mc.player.capabilities.allowFlying = true;
                    eventPlayerUpdateWalking.cancel();
                    eventPlayerUpdateWalking.setOnGround(false);
                    Globals.mc.player.velocityChanged = true;
                    Globals.mc.player.capabilities.isFlying = false;
                    Globals.mc.player.jump();
                    break;
                }
                eventPlayerUpdateWalking.cancel();
                eventPlayerUpdateWalking.setOnGround(true);
                Globals.mc.player.capabilities.isFlying = false;
                Globals.mc.player.capabilities.allowFlying = false;
                break;
            }
            case Anti: {
                if (!(Globals.mc.player.fallDistance > 3.0f)) break;
                Globals.mc.player.connection.sendPacket((Packet)new CPacketPlayer.Position(Globals.mc.player.posX, Globals.mc.player.posY + 1.0, Globals.mc.player.posZ, true));
                break;
            }
            case NCP: {
                if (!(Globals.mc.player.fallDistance > 4.0f)) break;
                Globals.mc.player.fallDistance = 0.0f;
                Globals.mc.player.connection.sendPacket((Packet)new CPacketPlayer.Position(Globals.mc.player.posX + 420420.0, Globals.mc.player.posY, Globals.mc.player.posZ, false));
                Globals.mc.player.connection.sendPacket((Packet)new CPacketPlayer.Position(Globals.mc.player.posX, Globals.mc.player.posY + 1.0, Globals.mc.player.posZ, true));
                break;
            }
        }
    }

    private void Method3074(EventNetworkPostPacketEvent eventNetworkPostPacketEvent) {
        CPacketEntityAction cPacketEntityAction;
        if (this.mode.getValue() == Class610.Avoid) {
            return;
        }
        if (eventNetworkPostPacketEvent.Method16() instanceof CPacketEntityAction && (cPacketEntityAction = (CPacketEntityAction)eventNetworkPostPacketEvent.Method16()).getAction() == CPacketEntityAction.Action.START_FALL_FLYING) {
            this.Field2569.Method47();
        }
    }
}

package me.ciruu.abyss.modules.exploit;

import io.netty.util.internal.ConcurrentSet;
import java.util.function.Predicate;
import me.ciruu.abyss.Class29;
import me.ciruu.abyss.Class30;
import me.ciruu.abyss.Globals;
import me.ciruu.abyss.enums.Class11;
import me.ciruu.abyss.enums.Class53;
import me.ciruu.abyss.events.network.EventNetworkPostPacketEvent;
import me.ciruu.abyss.events.network.EventNetworkPrePacketEvent;
import me.ciruu.abyss.events.player.EventPlayerMove;
import me.ciruu.abyss.events.player.EventPlayerUpdateWalking;
import me.ciruu.abyss.modules.Module;
import me.ciruu.abyss.settings.Setting;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketConfirmTeleport;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.server.SPacketPlayerPosLook;
import net.minecraft.util.math.Vec3d;

public class PacketPhase
extends Module {
    private final Setting speed = new Setting("Speed", "", (Module)this, (Object)Float.valueOf(1.0f), Float.valueOf(0.0f), Float.valueOf(6.0f));
    private final Setting phaseSpeed = new Setting("PhaseSpeed", "", (Module)this, (Object)Float.valueOf(0.034444444f), Float.valueOf(0.0f), Float.valueOf(1.0f));
    private final Setting Multiplier = new Setting("Multiplier", "", (Module)this, (Object)1, 1, 4);
    private final Setting noGround = new Setting("NoGround", "", this, false);
    private final ConcurrentSet Field959 = new ConcurrentSet();
    @EventHandler
    private Listener Field960 = new Listener<EventPlayerUpdateWalking>(this::Method1318, new Predicate[0]);
    @EventHandler
    private Listener Field961 = new Listener<EventNetworkPrePacketEvent>(PacketPhase::Method1319, new Predicate[0]);
    @EventHandler
    public Listener Field962 = new Listener<EventNetworkPostPacketEvent>(this::Method1320, new Predicate[0]);
    @EventHandler
    public Listener Field963 = new Listener<EventPlayerMove>(this::Method1321, new Predicate[0]);

    public PacketPhase() {
        super("PacketPhase", "", Class11.EXPLOIT);
        this.Method1322(this.Multiplier);
        this.Method1322(this.noGround);
    }

    public void Method1323() {
        super.Method13();
    }

    public void Method1324() {
        super.Method15();
        this.Field959.clear();
        Globals.mc.player.noClip = false;
    }

    public void Method1325(boolean bl) {
        if (this.Method1326()) {
            this.Method1327(false);
            this.Method1324();
        }
    }

    private void Method1328() {
        if (this.Method1329()) {
            double[] dArray = Class29.Method1330(0.03444444388151169);
            this.Method1331((CPacketPlayer)new CPacketPlayer.PositionRotation(Globals.mc.player.posX, Globals.mc.player.posY, Globals.mc.player.posZ, Globals.mc.player.rotationYaw, Globals.mc.player.rotationPitch, Globals.mc.player.onGround));
            for (int i = 1; i <= (Integer)this.Multiplier.getValue(); ++i) {
                if (Globals.mc.player.movementInput.moveStrafe == 0.0f && Globals.mc.player.movementInput.moveForward == 0.0f) {
                    Globals.mc.player.motionX = 0.0;
                    Globals.mc.player.motionZ = 0.0;
                } else {
                    Globals.mc.player.motionX = dArray[0] * (double)i;
                    Globals.mc.player.motionZ = dArray[1] * (double)i;
                }
                this.Method1332(Globals.mc.player.motionX, Globals.mc.player.motionY, Globals.mc.player.motionZ);
            }
        }
    }

    public void Method1332(Double d, Double d2, Double d3) {
        Vec3d vec3d = new Vec3d(d.doubleValue(), d2.doubleValue(), d3.doubleValue());
        Vec3d vec3d2 = Globals.mc.player.getPositionVector().add(vec3d);
        Vec3d vec3d3 = this.Method1333(vec3d, vec3d2);
        this.Method1331((CPacketPlayer)new CPacketPlayer.PositionRotation(vec3d2.x, vec3d2.y, vec3d2.z, Globals.mc.player.rotationYaw, Globals.mc.player.rotationPitch, Globals.mc.player.onGround));
    }

    public Vec3d Method1333(Vec3d vec3d, Vec3d vec3d2) {
        Vec3d vec3d3 = vec3d.add(vec3d2);
        return new Vec3d(vec3d3.x, 255.0, vec3d3.z);
    }

    public void Method1331(CPacketPlayer cPacketPlayer) {
        this.Field959.add((Object)cPacketPlayer);
        Globals.mc.player.connection.sendPacket((Packet)cPacketPlayer);
    }

    public boolean Method1329() {
        return Globals.mc.player.collidedHorizontally && (Globals.mc.world.getBlockState(Class30.Method209((EntityPlayer)Globals.mc.player)).getMaterial().isSolid() || Globals.mc.world.getBlockState(Class30.Method209((EntityPlayer)Globals.mc.player).add(0.0, (double)Globals.mc.player.eyeHeight, 0.0)).getMaterial().isSolid());
    }

    private void Method1321(EventPlayerMove eventPlayerMove) {
        if (!eventPlayerMove.isCancelled() && this.Method1329()) {
            eventPlayerMove.cancel();
            eventPlayerMove.Method107(Globals.mc.player.motionX);
            eventPlayerMove.Method105(Globals.mc.player.movementInput.jump || !Globals.mc.world.getBlockState(Class30.Method209((EntityPlayer)Globals.mc.player).down()).getMaterial().isSolid() ? (Globals.mc.player.motionY < 0.0 && Globals.mc.player.posY <= 1.0 ? 0.0 : Globals.mc.player.motionY) : 0.0);
            eventPlayerMove.Method108(Globals.mc.player.motionZ);
            Globals.mc.player.noClip = true;
            if (((Boolean)this.noGround.getValue()).booleanValue()) {
                Globals.mc.player.onGround = false;
            }
        } else {
            Globals.mc.player.noClip = false;
        }
    }

    private void Method1320(EventNetworkPostPacketEvent eventNetworkPostPacketEvent) {
        if (eventNetworkPostPacketEvent.Method16() instanceof CPacketPlayer && this.Method1329()) {
            if (this.Field959.contains((Object)((CPacketPlayer)eventNetworkPostPacketEvent.Method16()))) {
                this.Field959.remove((Object)((CPacketPlayer)eventNetworkPostPacketEvent.Method16()));
                return;
            }
            eventNetworkPostPacketEvent.cancel();
        }
    }

    private static void Method1319(EventNetworkPrePacketEvent eventNetworkPrePacketEvent) {
        if (Globals.mc.player != null && eventNetworkPrePacketEvent.Method49() instanceof SPacketPlayerPosLook) {
            SPacketPlayerPosLook sPacketPlayerPosLook = (SPacketPlayerPosLook)eventNetworkPrePacketEvent.Method49();
            Globals.mc.player.connection.sendPacket((Packet)new CPacketConfirmTeleport(sPacketPlayerPosLook.getTeleportId()));
            Globals.mc.player.setPosition(sPacketPlayerPosLook.getX() + Globals.mc.player.motionX, sPacketPlayerPosLook.getY(), sPacketPlayerPosLook.getZ() + Globals.mc.player.motionZ);
            eventNetworkPrePacketEvent.cancel();
        }
    }

    private void Method1318(EventPlayerUpdateWalking eventPlayerUpdateWalking) {
        if (eventPlayerUpdateWalking.Method100() == Class53.PRE && Globals.mc.player != null) {
            this.Method1328();
        }
    }
}
